/*! (c) Andrea Giammarchi - ISC */
const{navigator:e,ServiceWorker:t,SharedWorker:r,Worker:n}=globalThis,{isArray:s}=Array,{random:i}=Math,o=[],a=[],c=({data:{id:e,args:t}})=>{if(s(t)){const r=o.indexOf(e);-1<r&&a[r](...t)}},l=r=>r instanceof t?e.serviceWorker:r;let d=0;const h=(e,t,r,n=null,h=(e=>e))=>new Promise(((g,u)=>{let p=`proxied-worker:${t}:${d++}`;const f=l(e);if(f.addEventListener("message",(function e({data:{id:t,result:r,error:n}}){t===p&&(f.removeEventListener("message",e),null!=n?u(new Error(n)):g(h(r)))})),s(n)){r.push(n);for(let e=0,{length:t}=n;e<t;e++)switch(typeof n[e]){case"string":n[e]="$"+n[e];break;case"function":f.addEventListener("message",c);let t=a.indexOf(n[e]);t<0&&(t=a.push(n[e])-1,o[t]=`proxied-worker:cb:${d+++i()}`),n[e]=o[t]}}e.postMessage({id:p,list:r})}));function g(s,i={type:"classic"},o=n){const a=(e,t)=>new Proxy(u.bind({id:e,list:t}),g),c=new FinalizationRegistry((e=>{d.then((t=>t.postMessage({id:`proxied-worker:${e}:-0`,list:[]})))})),d=new Promise((n=>{if(o===r){const{port:e}=new o(s,i);e.start(),n(e)}else o===t?e.serviceWorker.register(s,i).then((({installing:e,waiting:t,active:r})=>n(e||t||r))):n(new o(s,i))})),g={apply(e,t,r){const{id:n,list:s}=e();return s[s.length-1]+=".apply",d.then((e=>h(e,n,s,r)))},construct(e,t){const{id:r,list:n}=e();return n[n.length-1]+=".new",d.then((e=>h(e,r,n,t,(e=>{const t=a(e,[]);return c.register(t,e),t}))))},get(e,t){const{id:r,list:n}=e(),{length:s}=n;switch(t){case"then":return s?(e,t)=>d.then((s=>h(s,r,n).then(e,t))):void 0;case"addEventListener":case"removeEventListener":if(!s&&!r)return(...e)=>d.then((r=>{l(r)[t](...e)}))}return a(r,n.concat(t))}};return a("",[])}function u(){return this}export{g as default};
