/*! (c) Andrea Giammarchi - ISC */
const{navigator:e,ServiceWorker:t,SharedWorker:r,Worker:n}=globalThis,{isArray:s}=Array,i=[],o=[],a=({data:{id:e,args:t}})=>{if(s(t)){const r=i.indexOf(e);-1<r&&o[r](...t)}},c=r=>r instanceof t?e.serviceWorker:r;let l=0;const d=(e,t,r,n=null,d=(e=>e))=>new Promise(((h,g)=>{let u=`proxied-worker:${t}:${l++}`;const p=c(e);if(p.addEventListener("message",(function e({data:{id:t,result:r,error:n}}){t===u&&(p.removeEventListener("message",e),null!=n?g(new Error(n)):h(d(r)))})),s(n)){r.push(n);for(let e=0,{length:t}=n;e<t;e++)switch(typeof n[e]){case"string":n[e]="$"+n[e];break;case"function":p.addEventListener("message",a);let t=o.indexOf(n[e]);t<0&&(t=o.push(n[e])-1,i[t]=`proxied-worker:cb:${l+++Math.random()}`),n[e]=i[t]}}e.postMessage({id:u,list:r})}));function h(s,i={type:"classic"},o=n){const a=(e,t)=>new Proxy(g.bind({id:e,list:t}),u),l=new FinalizationRegistry((e=>{h.then((t=>t.postMessage({id:`proxied-worker:${e}:-0`,list:[]})))})),h=new Promise((n=>{if(o===r){const{port:e}=new o(s,i);e.start(),n(e)}else o===t?e.serviceWorker.register(s,i).then((({installing:e,waiting:t,active:r})=>n(e||t||r))):n(new o(s,i))})),u={apply(e,t,r){const{id:n,list:s}=e();return s[s.length-1]+=".apply",h.then((e=>d(e,n,s,r)))},construct(e,t){const{id:r,list:n}=e();return n[n.length-1]+=".new",h.then((e=>d(e,r,n,t,(e=>{const t=a(e,[]);return l.register(t,e),t}))))},get(e,t){const{id:r,list:n}=e(),{length:s}=n;switch(t){case"then":return s?(e,t)=>h.then((s=>d(s,r,n).then(e,t))):void 0;case"addEventListener":case"removeEventListener":if(!s&&!r)return(...e)=>h.then((r=>{c(r)[t](...e)}))}return a(r,n.concat(t))}};return a("",[])}function g(){return this}export default h;
